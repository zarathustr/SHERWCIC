function [X, Y, f] = unified_fmincon_AX_YB(A, B, iter)
    syms qX0 qX1 qX2 qX3 real
    syms qY0 qY1 qY2 qY3 real
    syms tX0 tX1 tX2 real
    syms tY0 tY1 tY2 real
    J = vpa(expand(J_func_real(qX0, qX1, qX2, qX3, tX0, tX1, tX2, ...
                         qY0, qY1, qY2, qY3, tY0, tY1, tY2, ...
                         A, B)), 32);
    matlabFunction(J, 'File', 'J_func_real_.m');
    
    Xs = zeros(4, 4, iter);
    Ys = zeros(4, 4, iter);
    fs = zeros(iter, 1);
    parfor i = 1 : iter
        x0 = randn(12, 1);
        opt = optimoptions('fminunc', 'Display', 'off', ...
            'Algorithm', 'quasi-newton', ...
            'SpecifyObjectiveGradient', false, ...
            'OptimalityTolerance', 1e-200, ...
            'UseParallel', false);
            
        [x1, f] = fminunc(@J_func_fminunc_par, x0, opt);
        R = expm(times_(x1(1 : 3), 3));
        t = x1(4 : 6);
        X = [R, t;
             zeros(1, 3), 1];
        Xs(:, :, i) = X;
        R = expm(times_(x1(7 : 9), 3));
        t = x1(10 : 12);
        Y = [R, t;
             zeros(1, 3), 1];
        Ys(:, :, i) = Y;
        fs(i) = f;
    end
    
    [minimum, idx] = sort(fs);
    X = Xs(:, :, idx(1));
    Y = Ys(:, :, idx(1));
    f = fs(idx(1));
end

function J = J_func(x)
global A_ B_
R = expm(times_(x(1 : 3), 3));
t = x(4 : 6);
X = [R, t;
     zeros(1, 3), 1];
R = expm(times_(x(7 : 9), 3));
t = x(10 : 12);
Y = [R, t;
     zeros(1, 3), 1];
J = 0;
len = size(A_, 3);
for j = 1 : len
    XA = A_(:, :, j);
    XB = B_(:, :, j);
    res = XA * X - Y * XB;
    J = J + 1 / len * trace(res' * res);
end
end


function J = J_func_fminunc_par(x1)
RX = expm(times_(x1(1 : 3), 3));
tX = x1(4 : 6);
RY = expm(times_(x1(7 : 9), 3));
tY = x1(10 : 12); 
qX = dcm2quat(RX);
qX0 = qX(1); qX1 = qX(2); qX2 = qX(3); qX3 = qX(4);
qY = dcm2quat(RY);
qY0 = qY(1); qY1 = qY(2); qY2 = qY(3); qY3 = qY(4);

J = J_func_real_(qX0, qX1, qX2, qX3, qY0, qY1, qY2, qY3, tX(1), tX(2), tX(3), tY(1), tY(2), tY(3));
end


function J = J_func_real(qX0, qX1, qX2, qX3, tX0, tX1, tX2, ...
                         qY0, qY1, qY2, qY3, tY0, tY1, tY2, ...
                         A, B)
len = size(A, 3);
BB = [ qX0^4, qX0^2*qX1^2, qX0^2*qX2^2, qX0^2*qX3^2, qX0^2*qY0^2, qX0^2*qY0*qY1, qX0^2*qY0*qY2, qX0^2*qY0*qY3, qX0^2*qY1^2, qX0^2*qY1*qY2, qX0^2*qY1*qY3, qX0^2*qY2^2, qX0^2*qY2*qY3, qX0^2*qY3^2, qX0*qX1*qY0^2, qX0*qX1*qY0*qY1, qX0*qX1*qY0*qY2, qX0*qX1*qY0*qY3, qX0*qX1*qY1^2, qX0*qX1*qY1*qY2, qX0*qX1*qY1*qY3, qX0*qX1*qY2^2, qX0*qX1*qY2*qY3, qX0*qX1*qY3^2, qX0*qX2*qY0^2, qX0*qX2*qY0*qY1, qX0*qX2*qY0*qY2, qX0*qX2*qY0*qY3, qX0*qX2*qY1^2, qX0*qX2*qY1*qY2, qX0*qX2*qY1*qY3, qX0*qX2*qY2^2, qX0*qX2*qY2*qY3, qX0*qX2*qY3^2, qX0*qX3*qY0^2, qX0*qX3*qY0*qY1, qX0*qX3*qY0*qY2, qX0*qX3*qY0*qY3, qX0*qX3*qY1^2, qX0*qX3*qY1*qY2, qX0*qX3*qY1*qY3, qX0*qX3*qY2^2, qX0*qX3*qY2*qY3, qX0*qX3*qY3^2, qX1^4, qX1^2*qX2^2, qX1^2*qX3^2, qX1^2*qY0^2, qX1^2*qY0*qY1, qX1^2*qY0*qY2, qX1^2*qY0*qY3, qX1^2*qY1^2, qX1^2*qY1*qY2, qX1^2*qY1*qY3, qX1^2*qY2^2, qX1^2*qY2*qY3, qX1^2*qY3^2, qX1*qX2*qY0^2, qX1*qX2*qY0*qY1, qX1*qX2*qY0*qY2, qX1*qX2*qY0*qY3, qX1*qX2*qY1^2, qX1*qX2*qY1*qY2, qX1*qX2*qY1*qY3, qX1*qX2*qY2^2, qX1*qX2*qY2*qY3, qX1*qX2*qY3^2, qX1*qX3*qY0^2, qX1*qX3*qY0*qY1, qX1*qX3*qY0*qY2, qX1*qX3*qY0*qY3, qX1*qX3*qY1^2, qX1*qX3*qY1*qY2, qX1*qX3*qY1*qY3, qX1*qX3*qY2^2, qX1*qX3*qY2*qY3, qX1*qX3*qY3^2, qX2^4, qX2^2*qX3^2, qX2^2*qY0^2, qX2^2*qY0*qY1, qX2^2*qY0*qY2, qX2^2*qY0*qY3, qX2^2*qY1^2, qX2^2*qY1*qY2, qX2^2*qY1*qY3, qX2^2*qY2^2, qX2^2*qY2*qY3, qX2^2*qY3^2, qX2*qX3*qY0^2, qX2*qX3*qY0*qY1, qX2*qX3*qY0*qY2, qX2*qX3*qY0*qY3, qX2*qX3*qY1^2, qX2*qX3*qY1*qY2, qX2*qX3*qY1*qY3, qX2*qX3*qY2^2, qX2*qX3*qY2*qY3, qX2*qX3*qY3^2, qX3^4, qX3^2*qY0^2, qX3^2*qY0*qY1, qX3^2*qY0*qY2, qX3^2*qY0*qY3, qX3^2*qY1^2, qX3^2*qY1*qY2, qX3^2*qY1*qY3, qX3^2*qY2^2, qX3^2*qY2*qY3, qX3^2*qY3^2, tX0^2, tX0*tX1, tX0*tX2, qY0^2*tX0, qY0*qY1*tX0, qY0*qY2*tX0, qY0*qY3*tX0, qY1^2*tX0, qY1*qY2*tX0, qY1*qY3*tX0, qY2^2*tX0, qY2*qY3*tX0, qY3^2*tX0, tX0*tY0, tX0*tY1, tX0*tY2, tX0, tX1^2, tX1*tX2, qY0^2*tX1, qY0*qY1*tX1, qY0*qY2*tX1, qY0*qY3*tX1, qY1^2*tX1, qY1*qY2*tX1, qY1*qY3*tX1, qY2^2*tX1, qY2*qY3*tX1, qY3^2*tX1, tX1*tY0, tX1*tY1, tX1*tY2, tX1, tX2^2, qY0^2*tX2, qY0*qY1*tX2, qY0*qY2*tX2, qY0*qY3*tX2, qY1^2*tX2, qY1*qY2*tX2, qY1*qY3*tX2, qY2^2*tX2, qY2*qY3*tX2, qY3^2*tX2, tX2*tY0, tX2*tY1, tX2*tY2, tX2, qY0^4, qY0^2*qY1^2, qY0^2*qY2^2, qY0^2*qY3^2, qY0^2*tY0, qY0^2*tY1, qY0^2*tY2, qY0^2, qY0*qY1*tY1, qY0*qY1*tY2, qY0*qY1, qY0*qY2*tY0, qY0*qY2*tY2, qY0*qY2, qY0*qY3*tY0, qY0*qY3*tY1, qY0*qY3, qY1^4, qY1^2*qY2^2, qY1^2*qY3^2, qY1^2*tY0, qY1^2*tY1, qY1^2*tY2, qY1^2, qY1*qY2*tY0, qY1*qY2*tY1, qY1*qY2, qY1*qY3*tY0, qY1*qY3*tY2, qY1*qY3, qY2^4, qY2^2*qY3^2, qY2^2*tY0, qY2^2*tY1, qY2^2*tY2, qY2^2, qY2*qY3*tY1, qY2*qY3*tY2, qY2*qY3, qY3^4, qY3^2*tY0, qY3^2*tY1, qY3^2*tY2, qY3^2, tY0, tY0, tY1, tY1, tY2, tY2].';
AA = zeros(1, 208);
for j = 1 : len
    XA = A(:, :, j);
    XB = B(:, :, j);
    a11 = XA(1, 1); a12 = XA(1, 2); a13 = XA(1, 3); a14 = XA(1, 4);
    a21 = XA(2, 1); a22 = XA(2, 2); a23 = XA(2, 3); a24 = XA(2, 4);
    a31 = XA(3, 1); a32 = XA(3, 2); a33 = XA(3, 3); a34 = XA(3, 4);
    b11 = XB(1, 1); b12 = XB(1, 2); b13 = XB(1, 3); b14 = XB(1, 4);
    b21 = XB(2, 1); b22 = XB(2, 2); b23 = XB(2, 3); b24 = XB(2, 4);
    b31 = XB(3, 1); b32 = XB(3, 2); b33 = XB(3, 3); b34 = XB(3, 4);
    aa = [ a11^2 + a12^2 + a13^2 + a21^2 + a22^2 + a23^2 + a31^2 + a32^2 + a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, - 2*a11*b11 - 2*a12*b12 - 2*a13*b13 - 2*a21*b21 - 2*a22*b22 - 2*a23*b23 - 2*a31*b31 - 2*a32*b32 - 2*a33*b33, 4*a31*b21 - 4*a21*b31 - 4*a22*b32 + 4*a32*b22 - 4*a23*b33 + 4*a33*b23, 4*a11*b31 - 4*a31*b11 + 4*a12*b32 - 4*a32*b12 + 4*a13*b33 - 4*a33*b13, 4*a21*b11 - 4*a11*b21 - 4*a12*b22 + 4*a22*b12 - 4*a13*b23 + 4*a23*b13, 2*a21*b21 - 2*a12*b12 - 2*a13*b13 - 2*a11*b11 + 2*a22*b22 + 2*a23*b23 + 2*a31*b31 + 2*a32*b32 + 2*a33*b33, - 4*a11*b21 - 4*a21*b11 - 4*a12*b22 - 4*a22*b12 - 4*a13*b23 - 4*a23*b13, - 4*a11*b31 - 4*a31*b11 - 4*a12*b32 - 4*a32*b12 - 4*a13*b33 - 4*a33*b13, 2*a11*b11 + 2*a12*b12 + 2*a13*b13 - 2*a21*b21 - 2*a22*b22 - 2*a23*b23 + 2*a31*b31 + 2*a32*b32 + 2*a33*b33, - 4*a21*b31 - 4*a31*b21 - 4*a22*b32 - 4*a32*b22 - 4*a23*b33 - 4*a33*b23, 2*a11*b11 + 2*a12*b12 + 2*a13*b13 + 2*a21*b21 + 2*a22*b22 + 2*a23*b23 - 2*a31*b31 - 2*a32*b32 - 2*a33*b33, 4*a13*b12 - 4*a12*b13 - 4*a22*b23 + 4*a23*b22 - 4*a32*b33 + 4*a33*b32, 8*a23*b32 - 8*a22*b33 + 8*a32*b23 - 8*a33*b22, 8*a12*b33 - 8*a13*b32 - 8*a32*b13 + 8*a33*b12, 8*a13*b22 - 8*a12*b23 + 8*a22*b13 - 8*a23*b12, 4*a13*b12 - 4*a12*b13 + 4*a22*b23 - 4*a23*b22 + 4*a32*b33 - 4*a33*b32, 8*a13*b22 - 8*a12*b23 - 8*a22*b13 + 8*a23*b12, 8*a13*b32 - 8*a12*b33 - 8*a32*b13 + 8*a33*b12, 4*a12*b13 - 4*a13*b12 - 4*a22*b23 + 4*a23*b22 + 4*a32*b33 - 4*a33*b32, 8*a23*b32 - 8*a22*b33 - 8*a32*b23 + 8*a33*b22, 4*a12*b13 - 4*a13*b12 + 4*a22*b23 - 4*a23*b22 - 4*a32*b33 + 4*a33*b32, 4*a11*b13 - 4*a13*b11 + 4*a21*b23 - 4*a23*b21 + 4*a31*b33 - 4*a33*b31, 8*a21*b33 - 8*a23*b31 - 8*a31*b23 + 8*a33*b21, 8*a13*b31 - 8*a11*b33 + 8*a31*b13 - 8*a33*b11, 8*a11*b23 - 8*a13*b21 - 8*a21*b13 + 8*a23*b11, 4*a11*b13 - 4*a13*b11 - 4*a21*b23 + 4*a23*b21 - 4*a31*b33 + 4*a33*b31, 8*a11*b23 - 8*a13*b21 + 8*a21*b13 - 8*a23*b11, 8*a11*b33 - 8*a13*b31 + 8*a31*b13 - 8*a33*b11, 4*a13*b11 - 4*a11*b13 + 4*a21*b23 - 4*a23*b21 - 4*a31*b33 + 4*a33*b31, 8*a21*b33 - 8*a23*b31 + 8*a31*b23 - 8*a33*b21, 4*a13*b11 - 4*a11*b13 - 4*a21*b23 + 4*a23*b21 + 4*a31*b33 - 4*a33*b31, 4*a12*b11 - 4*a11*b12 - 4*a21*b22 + 4*a22*b21 - 4*a31*b32 + 4*a32*b31, 8*a22*b31 - 8*a21*b32 + 8*a31*b22 - 8*a32*b21, 8*a11*b32 - 8*a12*b31 - 8*a31*b12 + 8*a32*b11, 8*a12*b21 - 8*a11*b22 + 8*a21*b12 - 8*a22*b11, 4*a12*b11 - 4*a11*b12 + 4*a21*b22 - 4*a22*b21 + 4*a31*b32 - 4*a32*b31, 8*a12*b21 - 8*a11*b22 - 8*a21*b12 + 8*a22*b11, 8*a12*b31 - 8*a11*b32 - 8*a31*b12 + 8*a32*b11, 4*a11*b12 - 4*a12*b11 - 4*a21*b22 + 4*a22*b21 + 4*a31*b32 - 4*a32*b31, 8*a22*b31 - 8*a21*b32 - 8*a31*b22 + 8*a32*b21, 4*a11*b12 - 4*a12*b11 + 4*a21*b22 - 4*a22*b21 - 4*a31*b32 + 4*a32*b31, a11^2 + a12^2 + a13^2 + a21^2 + a22^2 + a23^2 + a31^2 + a32^2 + a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, 2*a12*b12 - 2*a11*b11 + 2*a13*b13 - 2*a21*b21 + 2*a22*b22 + 2*a23*b23 - 2*a31*b31 + 2*a32*b32 + 2*a33*b33, 4*a31*b21 - 4*a21*b31 + 4*a22*b32 - 4*a32*b22 + 4*a23*b33 - 4*a33*b23, 4*a11*b31 - 4*a31*b11 - 4*a12*b32 + 4*a32*b12 - 4*a13*b33 + 4*a33*b13, 4*a21*b11 - 4*a11*b21 + 4*a12*b22 - 4*a22*b12 + 4*a13*b23 - 4*a23*b13, 2*a12*b12 - 2*a11*b11 + 2*a13*b13 + 2*a21*b21 - 2*a22*b22 - 2*a23*b23 + 2*a31*b31 - 2*a32*b32 - 2*a33*b33, 4*a12*b22 - 4*a21*b11 - 4*a11*b21 + 4*a22*b12 + 4*a13*b23 + 4*a23*b13, 4*a12*b32 - 4*a31*b11 - 4*a11*b31 + 4*a32*b12 + 4*a13*b33 + 4*a33*b13, 2*a11*b11 - 2*a12*b12 - 2*a13*b13 - 2*a21*b21 + 2*a22*b22 + 2*a23*b23 + 2*a31*b31 - 2*a32*b32 - 2*a33*b33, 4*a22*b32 - 4*a31*b21 - 4*a21*b31 + 4*a32*b22 + 4*a23*b33 + 4*a33*b23, 2*a11*b11 - 2*a12*b12 - 2*a13*b13 + 2*a21*b21 - 2*a22*b22 - 2*a23*b23 - 2*a31*b31 + 2*a32*b32 + 2*a33*b33, - 4*a11*b12 - 4*a12*b11 - 4*a21*b22 - 4*a22*b21 - 4*a31*b32 - 4*a32*b31, 8*a31*b22 - 8*a22*b31 - 8*a21*b32 + 8*a32*b21, 8*a11*b32 + 8*a12*b31 - 8*a31*b12 - 8*a32*b11, 8*a21*b12 - 8*a12*b21 - 8*a11*b22 + 8*a22*b11, 4*a21*b22 - 4*a12*b11 - 4*a11*b12 + 4*a22*b21 + 4*a31*b32 + 4*a32*b31, - 8*a11*b22 - 8*a12*b21 - 8*a21*b12 - 8*a22*b11, - 8*a11*b32 - 8*a12*b31 - 8*a31*b12 - 8*a32*b11, 4*a11*b12 + 4*a12*b11 - 4*a21*b22 - 4*a22*b21 + 4*a31*b32 + 4*a32*b31, - 8*a21*b32 - 8*a22*b31 - 8*a31*b22 - 8*a32*b21, 4*a11*b12 + 4*a12*b11 + 4*a21*b22 + 4*a22*b21 - 4*a31*b32 - 4*a32*b31, - 4*a11*b13 - 4*a13*b11 - 4*a21*b23 - 4*a23*b21 - 4*a31*b33 - 4*a33*b31, 8*a31*b23 - 8*a23*b31 - 8*a21*b33 + 8*a33*b21, 8*a11*b33 + 8*a13*b31 - 8*a31*b13 - 8*a33*b11, 8*a21*b13 - 8*a13*b21 - 8*a11*b23 + 8*a23*b11, 4*a21*b23 - 4*a13*b11 - 4*a11*b13 + 4*a23*b21 + 4*a31*b33 + 4*a33*b31, - 8*a11*b23 - 8*a13*b21 - 8*a21*b13 - 8*a23*b11, - 8*a11*b33 - 8*a13*b31 - 8*a31*b13 - 8*a33*b11, 4*a11*b13 + 4*a13*b11 - 4*a21*b23 - 4*a23*b21 + 4*a31*b33 + 4*a33*b31, - 8*a21*b33 - 8*a23*b31 - 8*a31*b23 - 8*a33*b21, 4*a11*b13 + 4*a13*b11 + 4*a21*b23 + 4*a23*b21 - 4*a31*b33 - 4*a33*b31, a11^2 + a12^2 + a13^2 + a21^2 + a22^2 + a23^2 + a31^2 + a32^2 + a33^2, 2*a11^2 + 2*a12^2 + 2*a13^2 + 2*a21^2 + 2*a22^2 + 2*a23^2 + 2*a31^2 + 2*a32^2 + 2*a33^2, 2*a11*b11 - 2*a12*b12 + 2*a13*b13 + 2*a21*b21 - 2*a22*b22 + 2*a23*b23 + 2*a31*b31 - 2*a32*b32 + 2*a33*b33, 4*a21*b31 - 4*a31*b21 - 4*a22*b32 + 4*a32*b22 + 4*a23*b33 - 4*a33*b23, 4*a31*b11 - 4*a11*b31 + 4*a12*b32 - 4*a32*b12 - 4*a13*b33 + 4*a33*b13, 4*a11*b21 - 4*a21*b11 - 4*a12*b22 + 4*a22*b12 + 4*a13*b23 - 4*a23*b13, 2*a11*b11 - 2*a12*b12 + 2*a13*b13 - 2*a21*b21 + 2*a22*b22 - 2*a23*b23 - 2*a31*b31 + 2*a32*b32 - 2*a33*b33, 4*a11*b21 + 4*a21*b11 - 4*a12*b22 - 4*a22*b12 + 4*a13*b23 + 4*a23*b13, 4*a11*b31 + 4*a31*b11 - 4*a12*b32 - 4*a32*b12 + 4*a13*b33 + 4*a33*b13, 2*a12*b12 - 2*a11*b11 - 2*a13*b13 + 2*a21*b21 - 2*a22*b22 + 2*a23*b23 - 2*a31*b31 + 2*a32*b32 - 2*a33*b33, 4*a21*b31 + 4*a31*b21 - 4*a22*b32 - 4*a32*b22 + 4*a23*b33 + 4*a33*b23, 2*a12*b12 - 2*a11*b11 - 2*a13*b13 - 2*a21*b21 + 2*a22*b22 - 2*a23*b23 + 2*a31*b31 - 2*a32*b32 + 2*a33*b33, - 4*a12*b13 - 4*a13*b12 - 4*a22*b23 - 4*a23*b22 - 4*a32*b33 - 4*a33*b32, 8*a32*b23 - 8*a23*b32 - 8*a22*b33 + 8*a33*b22, 8*a12*b33 + 8*a13*b32 - 8*a32*b13 - 8*a33*b12, 8*a22*b13 - 8*a13*b22 - 8*a12*b23 + 8*a23*b12, 4*a22*b23 - 4*a13*b12 - 4*a12*b13 + 4*a23*b22 + 4*a32*b33 + 4*a33*b32, - 8*a12*b23 - 8*a13*b22 - 8*a22*b13 - 8*a23*b12, - 8*a12*b33 - 8*a13*b32 - 8*a32*b13 - 8*a33*b12, 4*a12*b13 + 4*a13*b12 - 4*a22*b23 - 4*a23*b22 + 4*a32*b33 + 4*a33*b32, - 8*a22*b33 - 8*a23*b32 - 8*a32*b23 - 8*a33*b22, 4*a12*b13 + 4*a13*b12 + 4*a22*b23 + 4*a23*b22 - 4*a32*b33 - 4*a33*b32, a11^2 + a12^2 + a13^2 + a21^2 + a22^2 + a23^2 + a31^2 + a32^2 + a33^2, 2*a11*b11 + 2*a12*b12 - 2*a13*b13 + 2*a21*b21 + 2*a22*b22 - 2*a23*b23 + 2*a31*b31 + 2*a32*b32 - 2*a33*b33, 4*a21*b31 - 4*a31*b21 + 4*a22*b32 - 4*a32*b22 - 4*a23*b33 + 4*a33*b23, 4*a31*b11 - 4*a11*b31 - 4*a12*b32 + 4*a32*b12 + 4*a13*b33 - 4*a33*b13, 4*a11*b21 - 4*a21*b11 + 4*a12*b22 - 4*a22*b12 - 4*a13*b23 + 4*a23*b13, 2*a11*b11 + 2*a12*b12 - 2*a13*b13 - 2*a21*b21 - 2*a22*b22 + 2*a23*b23 - 2*a31*b31 - 2*a32*b32 + 2*a33*b33, 4*a11*b21 + 4*a21*b11 + 4*a12*b22 + 4*a22*b12 - 4*a13*b23 - 4*a23*b13, 4*a11*b31 + 4*a31*b11 + 4*a12*b32 + 4*a32*b12 - 4*a13*b33 - 4*a33*b13, 2*a13*b13 - 2*a12*b12 - 2*a11*b11 + 2*a21*b21 + 2*a22*b22 - 2*a23*b23 - 2*a31*b31 - 2*a32*b32 + 2*a33*b33, 4*a21*b31 + 4*a31*b21 + 4*a22*b32 + 4*a32*b22 - 4*a23*b33 - 4*a33*b23, 2*a13*b13 - 2*a12*b12 - 2*a11*b11 - 2*a21*b21 - 2*a22*b22 + 2*a23*b23 + 2*a31*b31 + 2*a32*b32 - 2*a33*b33, a11^2 + a21^2 + a31^2, 2*a11*a12 + 2*a21*a22 + 2*a31*a32, 2*a11*a13 + 2*a21*a23 + 2*a31*a33, - 2*a11*b14 - 2*a21*b24 - 2*a31*b34, 4*a31*b24 - 4*a21*b34, 4*a11*b34 - 4*a31*b14, 4*a21*b14 - 4*a11*b24, 2*a21*b24 - 2*a11*b14 + 2*a31*b34, - 4*a11*b24 - 4*a21*b14, - 4*a11*b34 - 4*a31*b14, 2*a11*b14 - 2*a21*b24 + 2*a31*b34, - 4*a21*b34 - 4*a31*b24, 2*a11*b14 + 2*a21*b24 - 2*a31*b34, -2*a11, -2*a21, -2*a31, 2*a11*a14 + 2*a21*a24 + 2*a31*a34, a12^2 + a22^2 + a32^2, 2*a12*a13 + 2*a22*a23 + 2*a32*a33, - 2*a12*b14 - 2*a22*b24 - 2*a32*b34, 4*a32*b24 - 4*a22*b34, 4*a12*b34 - 4*a32*b14, 4*a22*b14 - 4*a12*b24, 2*a22*b24 - 2*a12*b14 + 2*a32*b34, - 4*a12*b24 - 4*a22*b14, - 4*a12*b34 - 4*a32*b14, 2*a12*b14 - 2*a22*b24 + 2*a32*b34, - 4*a22*b34 - 4*a32*b24, 2*a12*b14 + 2*a22*b24 - 2*a32*b34, -2*a12, -2*a22, -2*a32, 2*a12*a14 + 2*a22*a24 + 2*a32*a34, a13^2 + a23^2 + a33^2, - 2*a13*b14 - 2*a23*b24 - 2*a33*b34, 4*a33*b24 - 4*a23*b34, 4*a13*b34 - 4*a33*b14, 4*a23*b14 - 4*a13*b24, 2*a23*b24 - 2*a13*b14 + 2*a33*b34, - 4*a13*b24 - 4*a23*b14, - 4*a13*b34 - 4*a33*b14, 2*a13*b14 - 2*a23*b24 + 2*a33*b34, - 4*a23*b34 - 4*a33*b24, 2*a13*b14 + 2*a23*b24 - 2*a33*b34, -2*a13, -2*a23, -2*a33, 2*a13*a14 + 2*a23*a24 + 2*a33*a34, b11^2 + b12^2 + b13^2 + b14^2 + b21^2 + b22^2 + b23^2 + b24^2 + b31^2 + b32^2 + b33^2 + b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, 2*b14, 2*b24, 2*b34, - 2*a14*b14 - 2*a24*b24 - 2*a34*b34, 4*b34, -4*b24, 4*a34*b24 - 4*a24*b34, -4*b34, 4*b14, 4*a14*b34 - 4*a34*b14, 4*b24, -4*b14, 4*a24*b14 - 4*a14*b24, b11^2 + b12^2 + b13^2 + b14^2 + b21^2 + b22^2 + b23^2 + b24^2 + b31^2 + b32^2 + b33^2 + b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, 2*b14, -2*b24, -2*b34, 2*a24*b24 - 2*a14*b14 + 2*a34*b34, 4*b24, 4*b14, - 4*a14*b24 - 4*a24*b14, 4*b34, 4*b14, - 4*a14*b34 - 4*a34*b14, b11^2 + b12^2 + b13^2 + b14^2 + b21^2 + b22^2 + b23^2 + b24^2 + b31^2 + b32^2 + b33^2 + b34^2, 2*b11^2 + 2*b12^2 + 2*b13^2 + 2*b14^2 + 2*b21^2 + 2*b22^2 + 2*b23^2 + 2*b24^2 + 2*b31^2 + 2*b32^2 + 2*b33^2 + 2*b34^2, -2*b14, 2*b24, -2*b34, 2*a14*b14 - 2*a24*b24 + 2*a34*b34, 4*b34, 4*b24, - 4*a24*b34 - 4*a34*b24, b11^2 + b12^2 + b13^2 + b14^2 + b21^2 + b22^2 + b23^2 + b24^2 + b31^2 + b32^2 + b33^2 + b34^2, -2*b14, -2*b24, 2*b34, 2*a14*b14 + 2*a24*b24 - 2*a34*b34, 2, -2*a14, 2, -2*a24, 2, -2*a34];
    AA = AA + 1 / len * aa;
end
J = AA * BB + tY0^2 - 2*tY0 + tY1^2 - 2*tY1 + tY2^2 - 2*tY2;
end